jQuery(document).ready(function($) {

  let entered = false, interval = null;

  $('#wpse1_6817_btn').on('click', wpse1_6817_btn);
  $('#wpse1_6817_install_btn').on('click', wpse1_6817_btn_install);
  $('#wpse1_6817_btn').on('mouseenter', wpse1_6817_show);
  $('#wpse1_6817_btn').on('mouseleave', wpse1_6817_hide);
  function hideIt() {
    $('#wpse1_6817_who').hide(300);
    $('#wpse1_6817').css({
      'overflow': 'hidden',
      'max-height': $('#wpse1_6817').height(),
      'max-width': $('#wpse1_6817').width(),
      'opacity': 1
    });

    $('#wpse1_6817').animate({'max-height': '0px', 'opacity': '0', 'padding-top': '0', 'padding-bottom': '0', 'margin-top': '0'}, 300, function () {
      setTimeout(() => { $('#wpse1_6817').remove(); }, 10);
    });
  }
  function wpse1_6817_btn() {
    setTimeout(() => { hideIt(); }, 100);
    $.post(ajaxurl, { action: 'wpse1_6817_btn' }).done((res) => {

    });
  }
  function wpse1_6817_btn_install() {
    // setTimeout(() => { hideIt(); }, 100);
    $('#wpse1_6817_install_btn').css({'pointer-events': 'none', 'opacity': '.8'});
    $('#wpse1_6817_btns').addClass('wpse1_6817_btns_installing');
    $('#wpse1_6817_other').css({'max-width': `${$('#wpse1_6817_other').width()}px`, 'max-height': `${$('#wpse1_6817_other').height()}px`, 'overflow': 'hidden'});
    $('#wpse1_6817_show').css({'max-width': `${$('#wpse1_6817_show').width()}px`, 'overflow': 'hidden'});
    $('#wpse1_6817_dismiss').css({'max-width': `${$('#wpse1_6817_dismiss').width()}px`, 'overflow': 'hidden'});
    $('#wpse1_6817_other').animate({'padding-left': '0', 'max-width': '0'}, 500, function () {
      $('#wpse1_6817_btns, #wpse1_6817_install').css({'float': 'right'});
    });

    $('#wpse1_6817_text').css({'opacity': '1'});
    $('#wpse1_6817_text').animate({'opacity': '0'}, 500, function () {
      // $('#wpse1_6817_text').css({'line-height': '47px'});
      $('#wpse1_6817_text').html(`We\'re downloading this awesome plugin!<br>We will redirect you soon, please wait<span id="wpse1_6817_dots">...</span> :)`);
      $('#wpse1_6817_text').animate({'opacity': '1'}, 500, function () {
        let dox = '..', predox = '...';
        interval = setInterval(() => {
          $('#wpse1_6817_dots').text(dox);

          // I named it DOXPARADOX <3
          if (dox == '..' && predox == '...') { dox = '.'; predox = '..' }
          else if (dox == '.' && predox == '...') { dox = '..'; predox = '.' }
          else if (dox == '..' && predox == '..') { dox = '...'; predox = '..' }
          else if (dox == '.' && predox == '..') { dox = '..'; predox = '.' }
          else if (dox == '..' && predox == '.') { dox = '...'; predox = '..' }
          else { dox = '..'; predox = '...' }
        }, 700);
      });
    });

    $('#wpse1_6817_btns, #wpse1_6817_install').css({'text-align': 'right'});
    $('#wpse1_6817_show, #wpse1_6817_dismiss').css({'overflow': 'hidden', 'text-align': 'right'});

    $.post(ajaxurl, { action: 'wpse1_6817_install' }).done((res) => {
    
      if (isJsonString(res)) res = cdpParse(res);
      let url = $('#wpse1_6817').data('url');
      // if (res.status == 'success') window.location.href = `${url}/wp-admin/admin.php?page=copy-delete-posts`;
      if (res.status == 'success') window.location.reload();
      else if (typeof res.url != 'undefined') handleIssue();
      else handleIssue();
    }).fail(() => { handleIssue(); });

    function handleIssue() {
      clearInterval(interval);

      $('#wpse1_6817_text').animate({'opacity': '0'}, 500, function () {
        $('#wpse1_6817_text').html(`There was an error during plugin download :(<br>Please try to do it manualy, we will redirect you in <span id="wpse1_6817_dots">3</span>s.`);
        $('#wpse1_6817_text').animate({'opacity': '1'}, 500, function () {
          let i = 3;
          interval = setInterval(() => {
            i--;
            $('#wpse1_6817_dots').text(i);
            if (i == 0) {
              let url = $('#wpse1_6817').data('url');
              window.location.href = `${url}/wp-admin/plugin-install.php?s=CopyDeletePosts&tab=search&type=author`;
            }
          }, 1050);
        });
      });

    }
  }
  function wpse1_6817_show() {
    $('#wpse1_6817_smile').css({'opacity': 1});
  }
  function wpse1_6817_hide() {
    $('#wpse1_6817_smile').css({'opacity': 0});
  }

  function isJsonString(str) {
    try { JSON.parse(str); }
    catch (e) {
      if (typeof str === 'string') {
        let reversed = cdpReverseString(str);
        let lastcorrect = reversed.indexOf('}');
        if (lastcorrect == 0) lastcorrect = str.length;
        else lastcorrect = -lastcorrect;

        str = str.slice(str.indexOf('{'), lastcorrect);

        try {
          JSON.parse(str);
        } catch (e) {
          return false;
        }
        return true;
      } else return false;
    }
    return true;
  }

  function cdpReverseString(str) {
    if (typeof str === 'string')
      return (str === '') ? '' : cdpReverseString(str.substr(1)) + str.charAt(0);
    else
      return str;
  }

  function cdpParse(str) {
    try { JSON.parse(str); }
    catch (e) {
      if (typeof str === 'string') {
        let reversed = cdpReverseString(str);
        let lastcorrect = reversed.indexOf('}');
        if (lastcorrect == 0) lastcorrect = str.length;
        else lastcorrect = -lastcorrect;
        str = str.slice(str.indexOf('{'), lastcorrect);
        try {
          JSON.parse(str);
        } catch (e) {
          return false;
        }
        return JSON.parse(str);
      } else return false;
    }
    return JSON.parse(str);
  }

});